# 8월 23일 개발 로그

## 1. UI 문제 해결

- 어제 계획한 작업들

    1. 디스플레이 드라이버의 화면 갱신 콜백 함수에서 `waitDMA`가 반드시 필요한지 확인

    2. 화면 전환 애니메이션 다시 추가

    3. 광고 이미지 변경 방식을 단순 이미지 소스 전환으로 변경

    4. 실제 화면 표현을 확인하면서 픽셀 버퍼 라인 수 조절

- 추가로 LVGL Image Converter에서 아이콘을 알파 채널 포함한 Binary RGB565 포맷으로 변환해도 화면에 잘 표시되는지 테스트 해보아야 함

- 오늘 첫 빌드 포함 사항

    - [x] 화면 갱신 시 터치가 작동하도록 콜백 함수 조정

    - [x] 화면 전환 애니메이션 추가

    - [x] 이미지 소스 전환을 통한 광고 이미지 변경

    - [x] 메모리 여유 공간 확인

    - [x] main 스크린의 아이콘 하나를 통해 단순 변환 이미지가 잘 표현되는지 확인


### 디스플레이 드라이버의 화면 플러싱 콜백 함수에서 `waitDMA`는 정말 필요없는가?

- `waitDMA` 자체는 LovyanGFX에서 픽셀 버퍼를 읽어 DMA를 통해 화면에 뿌리는 것이 완료되는 것을 기다리는 작업

    - 이게 왜 필요하냐면, 화면에 뿌리는 작업이 완료되었음을 LVGL에 `lv_disp_flush_ready`를 통해 알려주고, 이후 픽셀 버퍼에 새로운 이미지를 LVGL이 담게 되는데, 아직 DMA가 해당 버퍼를 사용중이라면 읽고 있는 버퍼에 새 값이 쓰이면서 충돌이 발생할 수 있음

- 충돌 발생을 막으려면 일단 `waitDMA` 자체는 필요할 것 같은데, 문제는 광고 이미지 같은 큰 이미지를 화면에 표현하는데에 지금 시간이 상당히 오래걸리고, 그 동안은 터치 반응이 지연되는게 문제

- 찾아보니 DMA 전송이 끝나야 LVGL이 다음으로 터치 반응을 화면에 뿌리는 작업에 들어가기 때문에 논리적 반응은 선제적으로 처리할 수 있을 지언정 시각적 반응은 결국 지연되는 것을 막을 수 없음

- 시각적 반응 지연을 막을 수 없다면 딱히 이 문제를 해결하려 드는게 크게 의미가 없으니... 결론적으로 화면 플러싱을 최대한 가속시키는 방법을 찾는 수 밖에 없음


### 화면 버퍼 크기 결정

- LVGL이 화면에 픽셀을 뿌리는 순서가 딱히 있는 것은 아니지만, 버퍼 자체는 행 기준으로 왼쪽에서 오른쪽으로 나열된 형태

- 어차피 진짜 화면이 바뀌는 부분만 사각형 형태로 표현하기 때문에 굳이 화면의 가로, 세로 크기에 맞출 필요는 없음

- 현재 사용 중인 버퍼의 총 크기는 가로 800 픽셀 * 40줄 짜리 버퍼 * 2개 * 2바이트 = 약 128KB 정도

    - 이 때 남은 메모리 사용량이 약 200KB

- 픽셀 버퍼 빼고 나면 내부 SRAM의 여유 메모리가 320KB 정도니까 이 중 160KB 정도는 버퍼로 할당하는 것으로 결정

    - 혹시 나중에 내부 메모리 뻥나면 화면 버퍼를 최대한 줄이는 쪽으로...


### UI 마무리 작업

- 이 마무리 작업만 끝나면 UI 쪽은 당분간 손 댈 필요 없을 것 같음

- UI 마무리 빌드 포함 사항

    - [x] 픽셀 버퍼 크기 변경

    - [x] 메모리 정보 출력 함수를 외부 유틸리티로 분리

    - [ ] 코드 내 펌웨어 버전 정보 포함 및 UI 상 펌웨어 버전 표현


## 오늘 작업 마무리 시 해야할 일

- [ ] coffee-driver 업데이트

- [ ] 프로젝트 내 개인 일정 정리
