# 8월 29일 개발 로그

- 일단 다른 거 다 재끼고 코드 리팩토링 먼저. 진짜 금방할 줄 알았는데 어제 이걸로 시간 다 버림


## MQTT 토픽 관련 정리

### 기기에서 제공할 수 있는 데이터

- 전부 포함할 필요는 없고, 이 중에 괜찮아 보이는 것만 선별적으로 사용하면 될 듯

- 기기 부팅 후 네트워크 연결 시 기기 내부 RTC를 시간 서버로부터 받아서 초기화할 수 있으므로, 필요하다면 현재 시간은 쉽게 구현할 수 있음

1. 시스템 운영 / 관리 데이터

    - 기기 상태 모니터링

        - 펌웨어 버전

        - 전원 정보

            - 부팅된 후 흐른 시간

        - 네트워크 연결 상태
        
            - Health
            
            - 연결된 AP의 SSID

            - 연결 지속 시간
        
        - 오류 로그(기기 내부 오류 발생 시마다)

        - 잔여 메모리 / 스토리지 용량 정보

2. 매출 / 거래 관련 데이터

    - 상품별 거래 건수

    - 시간별 거래 건수

    - 시간대별 각 상품의 거래 건수

        - 모든 시간의 거래 건수를 확인할 필요는 없을 것 같고, 적당하게 시간대를 나누어(아침 / 점심 / 오후(peak) / 저녁 / 새벽 등) 제공하면 좋을 듯?

### 프론트엔드 기준 제공 기능

- 개인적으로 추천하는 메뉴 구성

  ```
  (root) -- 대시 보드
         |
         └- 가게 관리
         |
         └- 광고 관리
         |
         └- 펌웨어 관리 -- 배포 기록
         |            |
         |            └- 배포 관리
         |
         └- 시스템 관리 -- 연결된 기기 관리
         |            |
         |            └- 서버 관리
         |
         └- 모니터링
  ```

- 대시 보드

    - 다른 메뉴(가게 관리, 광고 관리, 펌웨어 관리, 모니터링 등)의 요약 내용을 작은 패널로 여러 개 배치해두면 한눈에 시스템 파악하기 좋을 것 같음

- 가게 관리

    - 추가되면 좋을 것 같음. 간단하게 MQTT 내 그룹 추가 / 삭제하는 느낌으로...

      (가게 테이블 예시)
      | 지역 | 가게명 |
      |------|--------|
      | 부산 금정 | 운죽정 |
      | 서울 마포 | 연남제비 |
      | 부산 금정 | 아이스고래 2호점 |

      지역은 시 / 군 / 구 단위나, 지역이 너무 많아질 것 같으면 단순히 시 / 도 단위(서울, 부산, 경북, 전남 등)으로 미리 정해두고, '가게 추가' 버튼을 통해 지역 선택 - 가게명까지만 입력받아 MQTT 그룹 하나 추가할 수 있도록.

      실제 데이터베이스로 구현할 때는 추가 / 삭제될 일 없는 지역 테이블 하나랑 지역 테이블을 FK로 가게명과 복합PK 구성하여 구현하면 될 듯(다른 지역에 동일한 가게명이 있을 수 있으므로)

- 광고 관리

    - 광고는 개수에 관계없이 등록할 수 있도록 구현하는 것이 좋을 것 같음. 아래 방식으로 가면 기기에서도 구현이 크게 어렵지 않음

    - 광고 관리를 더 편하게 하기 위해 광고 이미지를 올릴 때 파일 이름을 해당 광고 파일의 해시값(SHA-512 등)으로 정하면 좋을 것 같음. 보안 목적은 아니고 단순히 관리 편의를 위한 것이기 때문에 시스템 내에서 겹치지만 않는다면 단순히 Auto Increment 정수로 해도 됨.
    
      연결된 기기 관리 탭에서 현재 기기에서 표시되는 광고를 확인할 때는 단순히 지금 기기가 표시중인 광고들의 파일 제목을 보내주면 파일 제목에 적혀있는 해시값을 통해 광고 데이터베이스로부터 광고 정보를 받아 '이 광고가 표시 중이다'를 보여주면 좋을 것 같음

      광고를 등록할 때는 MQTT 토픽을 이용하여 지역별 / 가게별로 배포될 기기를 다르게 배포하고, 최소한 아래 정보는 시스템에서 배포 기록으로 가지고 있어야 할 것 같음

      | 배포 단위 | 세부 단위 | 배포 일시(UTC) | 배포 이미지 |
      |-----------|-----------|-------------------|-------------|
      | 지역 | 부산 금정 | 2025-08-29 12:31 | 5ee6d... |
      | 지역 | 서울 종로 | 2025-08-29 13:24 | 49a9f... |
      | 가게 | 아이스고래 2호점 | 2025-08-30 21:17 | 58edd... |

      위 내용을 데이터베이스로 관리한다면, '배포 이미지' 칼럼은 광고 테이블의 PK를 가져온 FK로 설정하고, 위 테이블 자체의 PK는 자동 넘버링으로 관리해야될 듯?

      만약 특정 광고 삭제 기능을 구현하려고 할 때 원래는 어떤 광고가 기기에서 표시되고 있는지를 시스템에서 일일히 기억하고 계산해야 하지만, 사실 그럴 필요 없이 위 테이블에 등록된 이미지만 기기에 등록된 상태일 것이기 때문에 위 테이블의 튜플 중 하나를 이용하여 광고를 취소하면 동일한 배포 단위 / 세부 단위 / 배포 이미지를 통해 MQTT 메시지를 구성하여 기기에 광고 삭제 명령을 내릴 수 있음(시스템에서 지역별 / 가게별 광고 구성을 기억할 필요 없음)

- 펌웨어 관리

    - 펌웨어도 광고와 동일하게 배포 단위 / 세부 단위까지 설정해주면 좋을 것 같음

    - 사소한 것이기는 한데, 시간을 UTC로 통일하였다면 `업로드 시간(UTC)`같은 식으로 UTC 기준임을 알려주면 좋을 것 같음

- 시스템 관리

    - 기기 자체는 MQTT 연결 / 연결 해제 시 자동으로 시스템에 추가 / 삭제

    - 개인적인 의견으로는, 기기 관리를 '시스템 관리'로 바꾸고 하위 메뉴로 연결된 기기 관리와 서버(백엔드) 관리로 나누는 것이 좋을 것 같음

        - 연결된 기기 관리는 연결된 각 기기에서 제공하는 [시스템 운영 / 관리 데이터](#기기에서-제공할-수-있는-데이터), 서버 관리는 Grafana 이용하여 백엔드 Health 관련된 정보들 제공하면 좋을 것 같음

        - [매출 / 거래 관련 데이터](#기기에서-제공할-수-있는-데이터)를 여기서 제공해도 안될 것은 없지만, 프론트엔드 자체가 가게 사장님들을 대상으로 한다면 오히려 매출 / 거래 관련 데이터를 '모니터링' 탭에 담는 것이 더 좋을 것 같음

- 모니터링

    - 위에서 먼저 말했듯이, 시스템 운영 / 관리 데이터는 연결된 기기 관리 탭에서 관리하고, 모니터링 탭에서는 매출 / 거래 관련 데이터를 확인할 수 있으면 좋을 것 같음
