# 🎐 구현 계획

## 계획

ESP32 기반 임베디드 보드 상에서 OTA 기술을 구현해보자. 이번 졸업과제의 목적은 클라우드 기반의 대규모 사물인터넷 단말 환경에서 OTA이지만 임베디드 소프트웨어를 개발하는 입장에서는 환경과 무관하게 OTA 기술을 구현하고, 그 윗단에서 OTA를 통해 업데이트할 펌웨어를 어떤 방식으로 효율적으로 배포할 것인가를 고민하는 방식으로 구현할 수 있다. 아무튼, 임베디드 소프트웨어는 단순히 OTA 기술만 구현하면 된다.

OTA 기술의 세부 구현 사항으로 고려해보아야 할 사항들이 상당히 많다. 우선 ESP32의 펌웨어 OTA의 작동 방식에 대해 깊이 조사해볼 필요가 있다. ESP32 OTA 자체는 제조사(에스프레시프인지 에스프레소인지 뭐시긴지 아무튼)에서 공식으로 제공을 하고 있기 때문에 분명 작동할 것이라는 믿음이 충분하지만, 이 기능을 이용하려면 생각보다 ESP 시스템 자체에 대해 깊이 이해해야 할 필요가 있다. OTA 도중에 시스템이 죽어버릴 수도 있다는 가정 하에 파티션 분할 구조를 사용하고, 업데이트 실패 시 롤백 로직이나 보안 전송 등의 기능은 기본 제공되는 사항이 아니라서(파티션 분할은 아직 찾아보지는 않았는데 아마 기본 제공될 듯) 직접 구현하면서 적용해야할 사항들이다.

앞서 말이 나왔던 것 처럼 보안 전송과 관련한 부분은 제조사가 아니라 개발자가 직접 책임져야할 부분이다. 보통은 HTTPS 통신 등을 통해 보안성을 확보하는 것으로 보이는데, 이 경우 인증서 발급 / 보드 상에서 인증 처리 및 해시 체크섬 등을 통한 무결성 검증 등 고려해야할 부분이 꽤 있다. 관련 내용은 웹 상에서 Let's Encrypt로 구현해본 것이 전부라서 저사양 단말에서 HTTPS 통신을 수행하는 것은 조금 더 찾아보아야 할 것 같다. 우선은 보안 관련 부분을 제하고 OTA 기술 자체를 구현한 다음 보안 관련 기능들을 추가하는 것이 좋아보인다. 아니면 아무 작업 안하는 함수 몇 개를 미리 끼워두는 것도 나쁘지 않을 것이다.

ESP32는 기본적으로 Wi-Fi 기반의 네트워크 연결을 수행하기 때문에 불안정한 네트워크를 기본으로 가정하고 들어가야 한다. 한국에서는 실내에서 동작하는 Wi-Fi가 대부분 빠르고 안정적으로 동작하기는 하지만 모든 Wi-Fi가 그런 것은 아니다. 당장 우리 학교 Wi-Fi만 봐도 알 수 있지 않는가! ESP32가 유선 LAN 연결을 통해 네트워크 연결을 수행하는 모델이 있는지는 모르겠지만 설마 MCU 주제에 그렇게까지 지원하지는 않을 것이다. 물론 Wi-Fi 모듈이랑 Bluetooth 모듈까지 달아놓은 듀얼 코어 MCU를 이 가격에 파는 것도 말이 안되기는 하니까 중국 쇼핑몰을 찾아보면 마개조된 물건이 하나쯤 나올지도 모르겠다. 이것이 대륙의 기상인가!

중국산 전자제품을 사용할 때는 쉽게 예상하기 어려운 보안 고려사항이 하나 더 있는데, 다름 아닌 백도어 문제... 별거 아닌 음모론 정도로 취급하는 사람도 있지만 중국이라는 나라는 애초에 보안법과 공산당의 압력에 의해 백도어를 심기 싫어도 심어야 하는 형국이라 분명히 실존하는 문제다. ESP 쪽도 관련 이슈가 크게 터진 적이 있었는데 당시에는 하드웨어를 까봐도 크게 미심쩍은 부분이 없었고 제조사에서도 공식적으로 부인했었기 때문에(중국 기업이 하는 말을 믿을 수 있느냐마는) 어느정도 일단락 되었다. 이번 과제에서 적용할 로직들은 중국 정부 입장에서도 딱히 필요없는 부분들이고 보안적으로 크게 중요한 내용도 없지만 괜히 곰돌이 푸 사진이라도 썼다가 무슨 해코지를 당할지 모르니 중국산 하드웨어를 사용할 때는 주의하는 편이 좋을 것이다. 이만한 가격에 이 정도 하드웨어를 사용하고 싶으면 어느정도 감내해야할 것은 감내해야 한다.

불안정한 네트워크를 고려하여 OTA를 구현한다고 하면 롤백 로직이나 펌웨어 분할 수신 등의 방법을 고려할 수 있다. 롤백 로직의 경우 새로 수신한 펌웨어로 임시 부팅하여 정상적 구동이 실패하면 이전 펌웨어로 재부팅하는 로직을 말하는데, 이는 ESP32 OTA 라이브러리에서 관련 기능을 제공하고 있으므로 이를 이용하여 구현한다. 펌웨어 분할 수신은 개발자 측에서 직접 구현해야하는데, 우리 팀의 경우 송신 측에서 미리 바이너리 파일을 분할하여 각 세그먼트에 해시 체크섬을 붙이고, 이를 기기와 송수신하여 기기에서 마지막으로 세그먼트 통합 후 재부팅하는 방식으로 구현한다.

펌웨어 OTA 다음으로 고려할 부분은 광고 교체 로직이다. 이 부분도 OTA라고 하면 OTA라고도 할 수 있는데, 광고 이미지나 영상 정도는 실행 관련 로직을 고려할 필요 없이 단순히 파일 교체만 생각하면 되기 때문에 크게 어려운 부분은 없다. 런타임에 광고를 바로 업데이트하는 로직이 제일 깔끔하기는 하지만 구현이 까다로울 수는 있다. LVGL GUI 프로그램도 결국은 이미지를 메모리에 올려서 표현하는 것이기 때문에 런타임에 이미지 파일이 교체되어도 크게 문제는 없지만 이미지 파일이 교체된 후 다시 이미지를 메모리에 로드하기 전까지는 동일한 광고 이미지가 표현될 것이다.

OTA 기능 외 과제의 주제에 맞게 고려해야할 부분들이 몇 가지 더 있다. 우선 기본적으로 업데이트에 사용될 펌웨어, 현재 과제를 기준으로 하자면 디스플레이에서 작동할 터치 기반 GUI 프로그램 자체를 개발할 필요가 있다. 이 부분에는 현재 사용할 디스플레이에서 작동이 가능하면서, ESP 기반 MCU에서 작동할 디스플레이 프로그램 개발에 많이 사용되는 LVGL을 이용하여 개발할 예정이다. 펌웨어가 업데이트 되는 모습을 보여야하기 때문에 기능 추가 등 버전이 다른 몇 가지의 펌웨어를 개발해두어야 한다.

OTA 다음으로 중요한 핵심 기능은 Arduino를 통해 수집하는 센서 데이터를 서버에 전송해주는 로직이다. 하나의 MCU에서 GUI 동작과 펌웨어 및 광고 OTA, 센서 데이터 전송 등 너무 많은 일을 하는 감이 없잖아 있기는 하지만 ESP32가 듀얼코어로 동작하는 만큼 멀티코어 프로그래밍을 통해 작업을 잘 분산할 수만 있다면 불가능한 일도 아닐 것이다. 센서 데이터 전송에는 MQTT를 이용한다.

참고로 ESP32 제조사에서 공식으로 AWS IoT Core 관련 라이브러리를 제공하고 있다! 이 과제에서 센서 데이터 전송이나 펌웨어 OTA 정보 등을 주고 받을 때는 기본으로 MQTT, 특히 AWS의 IoT Core 기반 브로커와 통신하도록 구현할 예정인데, 관련 라이브러리를 단말 보드 제조사에서 제공해주니 편하지 않을 수가 없다. 이것이 대륙의 기상인가!

다음으로 고민해보아야 하는 것은 Arduino 쪽 OTA 기술 개발이다. 이 부분은 관련 라이브러리가 많이 배포되고 있어서 크게 고민할 만한 부분은 아닐 수도 있지만, 만약 라이브러리가 잘 작동하지 않아 Arduino 쪽 OTA 기술 적용이 어렵다면 그것은 또 그것대로 문제가 된다. 우리의 핵심 기술에서는 조금 떨어진 부분이기는 하나, 없으면 또 상당히 아쉬운 부분이 될 수 있기 때문에 Arduino OTA 쪽도 최대한 개발하는 것으로 생각하자.

Arduino와 관련해서 하나 더 생각해볼 것은 실제로 디스플레이 조작을 통해 Arduino를 작동시키는 로직이다. 원래는 커피 머신 개발이 목적이지만 괜히 커피 원액이랑 물 가지고 커피를 제공해드렸다가 테크 위크를 식중독 위크로 만들 수는 없는 노릇이니 위생적으로 크게 문제가 없으면서 청탁금지법에도 걸리지 않을 정도로 커피 머신 대신 간단한 캔디 머신 정도는 만들 수 있을 것이다. 아두이노에 서보 모터를 하나 달아서 디스플레이 조작을 통해 맛이 다른 캔디를 꺼내줄 수 있는 정도는 구현하면 좋을 것이다. 사실 이 부분도 우리 핵심 로직과는 조금 거리가 있지만, 졸업과제의 평가는 결국 사람이 하는 것이기 때문에 기술적인 부분 외에 시각적인 부분을 추가로 보여드릴 수 있는 것이 있으면 좋을 것이다.

아직도 고민할 부분이 남았다! 문제는 시연 과정에 있는데, 대규모 사물인터넷 단말 환경에서 OTA를 작동시키는 모습을 보여드려야 하기 때문에 원칙적으로는 여러 대의 머신에서 OTA가 일어나는 것을 시연해야 하지만, 이미 한 대에 20만원이 넘어가는 디스플레이 구하는 데에도 팀장님의 통장을 털어버렸는데 여기서 더 털어버렸다가는 팀장님의 크루즈가 모닝이 되어버릴 수도 있으니 하드웨어 쪽은 최소한 보여드릴 수 있는 정도로만 보여드리고 나머지는 시뮬레이터나 LVGL을 에뮬레이션하는 프로그램을 개발하여 지역별로 나누어진 수십대의 LVGL 에뮬레이터를 통해 시연하는 것이 좋을 것이다. 이 시뮬레이터는 어느 파트에서 개발해야 할 지 애매하기는 한데 LVGL 관련이기는 하니 아마 내가 개발해야 하지 않을까싶다.

마지막으로 하나 더 생각해보자면, 이 부분은 조금 외적인 부분이기는 한데 하드웨어의 패키징에 대해 조금 고민해보아야 할 것 같다. 와이어링이 다 보이도록 사이버펑크 뺨치는 공돌이 스타일 디자인도 선호하는 편이지만, 평가하는 입장이나 향후 포트폴리오 등에 사용할 것을 생각해보면 겉으로 보이는 외형 또한 중요하게 생각해보아야 할 것이다. 박스로 패키징하는 것은 쉽기는 하지만 사이버펑크 스타일보다 짜치므로 이번에는 생각하지 않기로 하자. 3D 프린터를 이용한 외형 주물도 생각해볼 수 있으나 3D 프린터를 사용해본 적이 없어서 관련 내용은 핵심 기능이 완성된 후 추가로 고민해보아야 할 부분이다.

처음 구상할 때는 간단할 줄 알았는데 쓰고보니 시간 안에 개발이 가능할까 싶을 정도로 많기는 하다... 우선 순위에 따라 주요 기능들부터 차근차근 개발하면서 버려야할 부분은 빠르게 버리는 방향으로 개발하는 것이 좋을 것 같다. 구현해야할 부분들을 정리하고 우선 순위를 매기면 최종적으로 아래와 같이 정리할 수 있다.


1. 기본 개발 환경 구성 및 테스트

    - [x] ESP-IDF 구성

    - [ ] LVGL 라이브러리 통합

2. 펌웨어 OTA 기능 개발

    - [ ] ESP32 펌웨어 OTA 기술 조사

    - [ ] ESP32 OTA 테스트 구현

    - [ ] 롤백 및 펌웨어 분할 수신 기능 개발

3. 터치 기반 GUI 프로그램 개발

    - [ ] 기본 UI 개발

    - [ ] TF 카드로부터 컨텐츠 파일 로드 후 디스플레이 기능 개발

3. 보안 통신 구현

4. 컨텐츠 OTA 기능 개발

5. 센서 데이터 송수신 기능 개발

6. 시연용 시뮬레이터 개발

7. Arduino OTA 기능 개발

8. Arduino를 통한 기기 제어 기능 개발

9. 하드웨어 패키징
