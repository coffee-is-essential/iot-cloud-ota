# embedded firmware

## versions

### 0.0.1-alpha

- 기능 추가

    - UI

        - 광고 이미지 / 알파 채널을 포함한 아이콘

    - 광고 이미지 반복 표현

    - 펌웨어 버전 정보 표현


### 0.0.2-alpha

- 기능 추가

    - 설정 파일을 이용한 네트워크 초기화

    - Wi-Fi 연결


### 0.0.3-alpha

- 안정성 향상

    - IPC 기능 분리

    - cJSON nullptr 체크

    - 태스크 진행 중 새로운 태스크 발생 저지

- 버그 해결

    - 시리얼 로그를 전체적으로 가시성 좋게 정리

    - UI 조작으로 인한 시스템 불안정성 해결

- 기능 추가

    - 디버그 오버레이
    
        - 시리얼 모니터를 디스플레이로 바로 확인 가능

    - 파일 다운로드

    - OTA


### 0.0.4-alpha

- 기능 추가

    - MQTT 모듈 추가

- 안정성 향상

    - 파일 다운로드 시 해시(SHA-256) 검증


### 0.1.0

- 기능 추가

    - MQTT 발행 관련

    - 잘못된 펌웨어 업로드 시 자동 롤백

- 안정성 향상

    - 다수의 펌웨어 / 컨텐츠 다운로드 시 메모리 부족 문제 해결
    
    - 기타 안정성을 위한 버그 다수 해결


### 0.1.1

- 안정성 향상

    - 해시 검증 관련 버그 해결


### 0.1.2

- 안정성 향상

    - 컨텐츠 업데이트 관련 버그 해결


## known issues

### 알려진 문제(#1)

- 동일한 기기에 MQTT 메시지가 갑자기 많은 양이 전송되면 데이터 조각 정합성 문제가 발생할 수 있음

- MQTT 메시지는 길이가 긴 경우 메시지가 여러 조각으로 들어오기 때문에 이를 모아서 처리할 필요가 있는데, 현재는 해당 부분이 단일 메시지가 연속으로 들어온다는 가정 하에 메시지가 끝날 때까지 동일한 static 버퍼에 저장하도록 설계되어 있음

    - 한 번에 많은 메시지가 한 기기로 몰릴 경우, 메시지가 섞일 수도 있음

- 다만 메시지 처리 속도가 상당히 빠른 편이기 때문에, 한 메시지가 처리되기 전 여러 메시지가 한 번에 몰릴 경우가 지금은 거의 없을 것으로 예상되므로 일단 알려진 문제로 남겨둠

- 참고: 가능한 해결 방안으로, 해시 맵을 활용할 수 있음


### 알려진 문제(#2)

- 기본적으로 MQTT 클라이언트가 구독해야할 주제들은 비즈니스 로직에 따라 미리 정해져있는 것으로 간주하기 때문에 기기 출하 시 내부 설정 파일에 미리 포함됨

- MQTT 브로커와 연결 성공 이후 해당 설정을 읽어 주제를 하나씩 구독하게 되는데, 이 때 이 설정 파일에 오류가 있으면 아무런 주제를 구독하지 못하는 상태임에도 MQTT 클라이언트는 살아있게 됨

- 물론 설정 파일만 수정해서 재부팅하면 해결되는 문제지만, 그렇게 깔끔한 해결법은 아님

- 사실 이건 기기 출하 단계에서 발생하는 문제라서 굳이 펌웨어 상에서 에러 처리를 해야하나싶지만 우선은 견고성 향상을 위해 알려진 문제로 남겨둠

- 참고: 가능한 해결 방안으로, `MQTT_EVENT_CONNECTED` 콜백 내부에서는 플래그만 세워두고, 외부 태스크에서 MQTT 클라이언트를 종료시킬 수 있음
